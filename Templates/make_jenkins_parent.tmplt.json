{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This template coordinates the running of the Jenkins SecurityGroup, S3 and IAM templates.",
  "Metadata": {
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
        {
          "Label": {
            "default": "Child Templates"
          },
          "Parameters": [
            "SecurityGroupTemplate",
            "BucketTemplate",
            "IamRoleTemplate"
          ]
        }
      ]
    }
  },
  "Parameters": {
    "BucketTemplate": {
       "AllowedPattern": "^$|^http://.*$|^https://.*$",
      "Description": "URL to the child-template for creating the Jenkins S3 backup-bucket.",
      "Type": "String"
    },
    "IamRoleTemplate": {
       "AllowedPattern": "^$|^http://.*$|^https://.*$",
      "Description": "URL to the child-template for creating the Jenkins IAM instance role.",
      "Type": "String"
    },
    "JenkinsBackupBucket": {
      "AllowedPattern": "^[a-zA-Z][a-zA-Z0-9-]*[a-zA-Z0-9]*$|^$",
      "Description": "S3 Bucket to host backup files (if left blank, a value will be computed).",
      "Type": "String"
    },
    "SecurityGroupTemplate": {
      "AllowedPattern": "^$|^http://.*$|^https://.*$",
      "Description": "URL to the child-template for creating the Jenkins network security-groups.",
      "Type": "String"
    },
    "TargetVPC": {
      "AllowedPattern": "^vpc-[0-9a-f]*$",
      "Description": "ID of the VPC to deploy Jenkins components into.",
      "Type": "AWS::EC2::VPC::Id"
    }
  },
  "Resources": {
    "IamRes": {
      "Properties": {
        "Parameters": {
          "JenkinsBucketArn": {
            "Fn::GetAtt": [
              "S3Res",
              "Outputs.JenkinsBucketArn"
            ]
          }
        },
        "TemplateURL": {
          "Ref": "IamRoleTemplate"
        },
        "TimeoutInMinutes": "10"
      },
      "Type": "AWS::CloudFormation::Stack"
    },
    "S3Res": {
      "Properties": {
        "Parameters": {
          "JenkinsBackupBucket": {
            "Ref": "JenkinsBackupBucket"
          }
        },
        "TemplateURL": {
          "Ref": "BucketTemplate"
        },
        "TimeoutInMinutes": "10"
      },
      "Type": "AWS::CloudFormation::Stack"
    },
    "SgRes": {
      "Properties": {
        "Parameters": {
          "TargetVPC": {
            "Ref": "TargetVPC"
          }
        },
        "TemplateURL": {
          "Ref": "SecurityGroupTemplate"
        },
        "TimeoutInMinutes": "10"
      },
      "Type": "AWS::CloudFormation::Stack"
    }
  }
}
